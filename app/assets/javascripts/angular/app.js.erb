var app = angular.module("rcloudApp", ["ngRoute"]);

app.controller("MainCtrl", function ($scope, $http) {
  $scope.currentUser = null;
  $scope.userLibrary = [];

  $http.get("/account.json")
    .success(function (user) {
      $scope.currentUser = user;
      console.log("Get current User");
  });


  $scope.soundCloudConnect = function() {
    SC.connect(function() {
      SC.get('/me', function(response) {
        var value = SC.accessToken();
        createCookie("accessToken", value, 30);
      });
    });
  };


  var getSoundCloudLibrary = function() {
    var token = getCookie('accessToken');
    SC.get('/me/favorites?oauth_token=' + token, function(response) {
      console.log(response);
      var tracks = response;

      $scope.$apply(function(){
        for(var i=0; i<tracks.length; i++ ) {  
          var track = tracks[i];
          track.source = "soundCloud";
          $scope.userLibrary.push(track);
        }
      });  
    });
  };

  var getRdioLibrary = function() {
    if (R.currentUser) {
      R.request({
        method: "getTracksInCollection", 
        content: {
          user: R.currentUser.get("key"), 
          count: 100,
        }, complete: function(response) {
          $scope.$apply(function(){
            var tracks = response.result;
            for(var i=0; i<tracks.length; i++ ) {  
              var track = tracks[i];
              track.source = "rdio";
              $scope.userLibrary.push(track);
            }
          });
        }
      });
    }
  };

  $scope.getLibrary = function() {
    getRdioLibrary();
    getSoundCloudLibrary();
  };  

  $scope.signIn = function() {
    alert();
    R.ready(function() {
      console.log("R Ready");
      R.authenticate();
    });
    
  };

  $scope.signOut = function() {
    $http.delete("/users/sign_out.json")
      .success(function(res) {
        $scope.currentUser = null;
      });
  };

  $scope.search = function(query) {
    $scope.search.results = [];

    // Rdio Search
    // –––––––––––––––
    R.request({
      method: "search", 
      content: {
        query: query, 
        types: "Track", // changes to find artist, track, or album
        count: 100
      },
      success: function(response) {
        var tracks = response.result.results;
        // add rdio source to identify which player to use
        // add to results array
        $scope.$apply(function () {
          for(var i=0; i<tracks.length; i++ ) {
            var track = tracks[i];
            track.source = "rdio";
            $scope.search.results.push(track);
          }
        });
        
        // reset form       
        $scope.query = null;
        angular.element("form")[0].reset();
        angular.element("form")[0].blur();
        // update scope
        

        
      },
      error: function(response) {
        console.log("error");
        $(".error").text(response.message);
      }
    });

    // SoundCloud Search
    // –––––––––––––––
    SC.get('/tracks', { q: query, license: 'cc-by-sa' }, function(tracks) {
      $scope.$apply(function(){
        for(var i=0; i<tracks.length; i++) {
          var track = tracks[i];
          // add soundCloud key to identify which player to use
          track.source = "soundCloud";
          // convert duration to seconds to match rdio
          track.duration = (track.duration / 1000);
          // add to results array
          $scope.search.results.push(track);
        }
      });

    });
  };

  $scope.closeSearch = function() {
    $scope.search.results = null;
  };

  $scope.currentPosition = 0;

  $scope.playTrack = function(track) {    
    rcloud.play(track);
    $scope.nowPlaying = rcloud.queue[0];

    R.player.on("change:position", function(position) {
      $scope.currentPosition = position;
      $scope.$apply();
    });
  };

  $scope.queue = rcloud.queue;

  $scope.queueTrack = function(track) {
    rcloud.queue.push(track);
  };

  $scope.togglePause = function() {
    rcloud.togglePause();
  };
  $scope.previous = function() {
    // R.player.previous();
  };
  $scope.next = function() {
    rcloud.next();
  };

});

// time filter
app.filter('secondsToDateTime', [function() {
    return function(seconds) {
        return new Date(1970, 0, 1).setSeconds(seconds);
    };
}]);

