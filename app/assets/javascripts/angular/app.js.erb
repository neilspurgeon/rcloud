//= depend_on_asset "angular/main.html"

var app = angular.module("rcloudApp", ["ngRoute"]);


// Routes
app.config(function ($routeProvider, $httpProvider) {

  $routeProvider
    .when("/", {
      controller: "MainCtrl",
      templateUrl: "<%= asset_path('angular/main.html') %>"
    })
    .when("/account", {
      controller: "AccountCtrl",
      template: "account.html"
    })
    .otherwise({
      redirectTo: "/"
    })

  $httpProvider
    .defaults.headers.common["X-CSRF-Token"] = $("meta[name=csrf-token]").attr("content");
})

app.controller("MainCtrl", function ($scope, $http) {
  $scope.currentUser = null;

  $http.get("/account.json")
    .success(function (user) {
      $scope.currentUser = user;
      console.log("Get current User");
    })

    $scope.signIn = function() {
      alert("sign in function")
    }

    $scope.signOut = function() {
      $http.delete("/users/sign_out.json")
        .success(function(res) {
          $scope.currentUser = null;
        }) 
    }

  $scope.search = function(query) {
    $scope.search.results = [];

    // Rdio Search
    // –––––––––––––––
    R.request({
      method: "search", 
      content: {
        query: query, 
        types: "Track", // changes to find artist, track, or album
        count: 100
      },
      success: function(response) {
        var tracks = response.result.results;
        // add rdio source to identify which player to use
        // add to results array
        for(var i=0; i<tracks.length; i++ ) {
          var track = tracks[i];
          track["source"] = "rdio";
          $scope.search.results.push(track)
        }
        
        // reset form       
        $scope.query = null;
        angular.element("form")[0].reset();
        angular.element("form")[0].blur();
        // update scope
        $scope.$apply();
      },
      error: function(response) {
        console.log("error");
        $(".error").text(response.message);
      }
    });

    // SoundCloud Search
    // –––––––––––––––
    SC.get('/tracks', { q: query, license: 'cc-by-sa' }, function(tracks) {

      for(var i=0; i<tracks.length; i++) {
        var track = tracks[i];
        // add soundCloud key to identify which player to use
        track["source"] = "soundCloud";
        // convert duration to seconds to match rdio
        track.duration = (track.duration / 1000);
        // add to results array
        $scope.search.results.push(track)
      }

      // update scope
      $scope.$apply();
    });


  };

  $scope.closeSearch = function() {
    $scope.search.results = null;
  }

  $scope.play = function(track) {
    console.log(track)
    rcloud.play(track);
  }
});


app.controller("PlayerCtrl", function ($scope) {
  $scope.nowPlaying = {};

  $scope.togglePause = function() {
    R.player.togglePause()
  }
  $scope.previous = function() {
    R.player.previous()
  }
  $scope.next = function() {
    R.player.next()
  }

});



// Rcloud Player - Set Up
// ––––––––––––––––––––––––––––––––––––––––––––––––––––
var RcloudPlayer = function () {
  var self = this;
  this.queue = [];
  this.nowPlaying = this.queue[0];
  this.nowPlayingSource = self.nowPlaying ? self.nowPlaying.source : null;
  this.soundCloudPlayer;
  this.soundCloudSettings = {useHTML5Audio: true, preferFlash: false};

  // SoundCloud player Init
  SC.initialize({
    client_id: 'f3a51baca351723ad612f5318b1be836',
    redirect_uri: 'http://localhost:3000'
  });
}



// Rcloud Player - Play
// ––––––––––––––––––––––––––––––––––––––––––––––––––––
RcloudPlayer.prototype.play = function (track) {
  var self = this;
  // add track to beggining of queue
  this.queue[0] = track;

  // Rdio workaround to signal track is finished playing
  // Couldn't find an Rdio method to do this
  var rdioFinished = function() {
    var check = setInterval(function (){
        console.log("checking...")
        if (R.player.position() === 0){
          alert("DONE");
          clearInterval(check);
          return true;
        }
        return false;
      }, 1000); 
  }


  // determine Rdio or SoundCloud player
  if (track.source === "rdio") { 
    R.player.play({source: track.key});
    rdioFinished();
  } else if (track.source === "soundCloud") {
    SC.stream("/tracks/" + track.id, self.soundCloudSettings, function(sound){  
      self.soundCloudPlayer = sound;                    // set track
      html5Audio = sound._player._html5Audio;           // use html audio
      html5Audio.addEventListener('ended', function(){  
        // track is over, play next in queue
        console.log('event fired: ended');
      });
      self.soundCloudPlayer.play();
    });

  }
}

//  Rcloud Player - Init 
// ––––––––––––––––––––––––––––––––––––––––––––––––––––
var rcloud = new RcloudPlayer();

// time filter
app.filter('secondsToDateTime', [function() {
    return function(seconds) {
        return new Date(1970, 0, 1).setSeconds(seconds);
    };
}])

